<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sanmei.dao.cos.CosSignInDao">

    <resultMap id="baseMap" type="com.sanmei.model.cos.CosSignIn">
        <id column="id" property="id"></id>
        <result column="data_control" property="dataControl"></result>
        <result column="course_id" property="courseId"></result>
        <result column="course_name" property="courseName"></result>
        <result column="schedule_id" property="scheduleId"></result>
        <result column="schedule_no" property="scheduleNo"></result>
        <result column="schedule_name" property="scheduleName"></result>
        <result column="schedule_date" property="scheduleDate"></result>

        <result column="user_id" property="signUserId"></result>
        <result column="username" property="userName"></result>
        <result column="nickname" property="nickName"></result>

        <result column="start_time" property="startTime"></result>
        <result column="sign_time" property="signTime"></result>

        <result column="create_time" property="createTime"></result>
        <result column="update_time" property="updateTime"></result>
    </resultMap>

    <!--查询签到信息-->
    <select id="selectCosSignIn" parameterType="com.sanmei.model.cos.CosSignIn"
            resultMap="baseMap">
        select  a.course_id,d.course_name,a.id as schedule_id,a.schedule_no,a.schedule_name,a.schedule_date,a.last_date,
        b.id,b.user_id,c.username,c.nickname,
        a.start_time,b.sign_time,
        b.update_time,b.create_time
        from cos_schedule a
        left join cos_sign_in b on a.id=b.schedule_id
        left join sys_user c on b.user_id=c.id
        left join cos_courses d on a.course_id=d.id
        where a.delete_status = 1 and a.course_id= #{courseId}
        <if test="tempScheduleId !='' and tempScheduleId !=null">
            and a.id=#{tempScheduleId}
        </if>
        <if test="keywords !='' and keywords !=null">
            and c.nickname like CONCAT('%', #{keywords}, '%')
        </if>
        order by a.schedule_no,b.update_time
    </select>

    <!-- 签到是否存在-->
    <select id="queryExistSignIn" parameterType="com.sanmei.model.cos.CosSignIn"
            resultType="int">
        select count(0)
        from cos_sign_in
        WHERE schedule_id=#{scheduleId}
          AND user_id=#{userId};
    </select>

    <!--新增-->
    <insert id="addCosSignIn" parameterType="com.sanmei.model.cos.CosSignIn">
        insert into cos_sign_in (schedule_id,user_id,sign_time)
        values (#{scheduleId},#{userId},#{signTime})
    </insert>

    <!--获取所有课时-->
    <select id="getCourseSchedule" parameterType="com.sanmei.model.cos.CosSignIn" resultType="com.sanmei.model.cos.CosCourseSchedule">
        select id           id,
               schedule_no  scheduleNo,
               schedule_name scheduleName
        from cos_schedule
        where course_id=#{courseId}
          and delete_status='1'
    </select>

    <!--获取班内人员列表-->
    <select id="getClassUsers" parameterType="com.sanmei.model.cos.CosSignIn" resultType="com.sanmei.model.sysUser.SysUser">
        select a.user_id     id,
               b.username    userName,
               b.nickname    nickname
        from cos_class a
        left join sys_user b on a.user_id =b.id
        where a.course_id=#{courseId}
          and a.delete_status = '1'
          and a.role != '讲师'
    </select>

</mapper>